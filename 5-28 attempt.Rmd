---
title: "5/28 Decil & Age Sample Restriction"
output: html_document
date: "2024-05-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo = FALSE, include=FALSE}
library(tidyverse)
library(haven)
library(broom)
```


## Preprocess

-   Drop 1 observation

```{r}
raw_data <- read_dta("CASEN_allyears_v4.dta")

test <- raw_data |> filter(subsidio_joven == 1)
table(test$decil)
table(test$age)
table(test$year)
```

```{r}
df_casen <- as.data.frame(raw_data)
df_casen <- df_casen |> 
  select(-c(municipality, id, subsidio_joven_req, subsidio_joven_req_income)) |> 
  # drop 1 obs. 
  filter(
    if_any(
      .fns = ~ !is.na(.x),
      .cols = c(region, urb, age, gender, totalincome_hh)
    )
  ) |>
  mutate(
    # Substitute NA by 0
    across(
      .fns = ~ if_else(is.na(.x), 0, .x),
      .cols = c(subsidio_joven, subsidio_joven_income, 
                jobincome, totalincome, totalincome_hh)
    ),
    across(
      .fns = ~ as.factor(.x), 
      .cols = c(region, urb, gender, student)
    ),
    # New level of factor
    # across(
    #   .fns = ~ fct_na_value_to_level(as.factor(.x), level = "NA"), 
    #   .cols = c(familysize, civilstatus, educ, decil, activ)
    # ),
    # familysize = fct_collapse(familysize, ">=11" = c('11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '25')), 
    experience = age - schooling - 6, 
    lfp = if_else(activ %in% 1:2, 1, 0), 
    employment = if_else(activ == 1, 1, 0), 
    unemployment =  if_else(activ == 2, 1, 0), 
    id = row_number()
  )
```

## DID variables

-   Eligible: (i) individuals aged between 18 and 25; (ii) individuals who actually took subsidies

-   Non-eligible: individuals aged between 26 and 29 and those who do not take subsidies

```{r}
df_casen <- df_casen |> 
  mutate(
    eligible = if_else(
      age %in% 23:25 & schooling >= 12, 
      1, 
      0
    ), 
    non_eligible = if_else(
      (age %in% 26:28) & (subsidio_joven == 0) & schooling >= 12, 
      1,
      0
    ), 
    post = if_else(year > 2009, 1, 0),
    lineartrend = year - 2009, 
    period = as.factor(year - 2009) |> relevel(ref = "-3"),
    gname = if_else(eligible == 1, 2009, 0), 
  ) 
```

## Sample restriction

```{r}
df_casen <- df_casen |> 
  filter(eligible == 1 | non_eligible == 1) |> 
  filter(student != "1" & gender == "1") |> 
  filter(year >= 2000) %>%
  filter(decil < 9)

# table(df_casen$treatment)
```

## Save 

```{r}
df_intensive <- df_casen |> 
  filter(
    jobincome > 0 & totalincome > 0 
  ) |> 
  # filter(
  #   jobincome <= quantile(jobincome, 0.99) & jobincome <= quantile(totalincome, 0.99)
  # ) |> 
  mutate(
    across(
      .cols = c(jobincome, totalincome, hours), 
      .fns = log,
      .names = "log_{.col}"
    )
  )



df_extensive <- df_casen

```



```{r}

run_ols <- function(data, outcome, control = FALSE, linear_pretrend = FALSE) {
  if (control == FALSE & linear_pretrend == FALSE) {
    fml <- stats::as.formula(paste0(outcome, "~ eligible*period"))
  } else if (control == FALSE & linear_pretrend == TRUE) {
    fml <- stats::as.formula(paste0(outcome, "~ eligible*period + eligible:lineartrend"))
  } else if (control == TRUE & linear_pretrend == FALSE) {
    fml <- stats::as.formula(paste0(outcome, " ~ eligible*period + experience + I(experience^2) + schooling + I(schooling^2) + civilstatus + region*urb"))
  } else {
    fml <- stats::as.formula(paste0(outcome, " ~ eligible*period + eligible:lineartrend + experience + I(experience^2) + schooling + I(schooling^2) + civilstatus + region*urb"))
  }
  
  mod <- stats::lm(
    fml, 
    data = data, 
    weights = expr
  )
  
  return(mod)
}

# Extract coefficients and confidence intervals for the OLS
#' 
prep_event_study_plot <- function(model) {
  
  df_model <- stats::coef(summary(model))
  
  df_model <- data.frame(
    period = row.names(df_model),
    estimate = df_model[, "Estimate"],
    std_error = df_model[, "Std. Error"],
    conf_low = df_model[, "Estimate"] - 1.96 * df_model[, "Std. Error"],
    conf_high = df_model[, "Estimate"] + 1.96 * df_model[, "Std. Error"], 
    row.names = NULL
  ) |>
    dplyr::filter(stringr::str_detect(period, "eligible:period")) |> 
    dplyr::mutate(period = stringr::str_replace(period, "eligible:period", "") |> as.numeric()) |> 
    dplyr::add_row(period = -3, estimate = 0, conf_low = 0, conf_high = 0)
  
  return(df_model)
}

#' @export
plot_event_study <- function(mod1, mod2) {
  event_study_plot <- rbind(
    prep_event_study_plot(mod1) |>
      dplyr::mutate(model = "1. No Control"),
    prep_event_study_plot(mod2) |>
      dplyr::mutate(model = "2. Control")
  )
  
  g <- ggplot2::ggplot(event_study_plot, ggplot2::aes(x = period, y = estimate, ymin = conf_low, ymax = conf_high)) +
    ggplot2::geom_hline(yintercept = 0, linetype = "dashed", colour = "gray") +
    ggplot2::geom_vline(xintercept = -3, linetype = "dashed", colour = "gray") +
    ggplot2::geom_errorbar(width = 0.4) +
    ggplot2::geom_point() +
    ggplot2::facet_wrap(. ~ model) +
    ggplot2::labs(x = "Period", y = "Coefficient", title = paste0(summary(mod1)[["terms"]][[2]], " (OLS)")) + 
    ggplot2::theme_bw()
  
  return(g)
}

#' #' 
#' run_feols <- function(data, outcome, control = TRUE) {
#'   if (control == FALSE) {
#'     mod <- feols(
#'       stats::as.formula(paste0(outcome, " ~ eligible + i(period, eligible, 0) + eligible:lineartrend | period")), 
#'       data, 
#'       # weights = data$expr,
#'       "iid"
#'     )
#'   } else {
#'     mod <- feols(
#'       stats::as.formula(paste0(outcome, " ~ eligible + i(period, eligible, 0) + schooling + I(schooling^2) + civilstatus + region*urb | period")),
#'       data,
#'       # weights = data$expr,
#'       vcov = "cluster"
#'     )
#'   }
#'   
#'   return(mod)
#' }

#' @export
run_cs <- function(data, outcome, xfm = NULL, est_method = "ipw") {
  if (is.null(xfm)) {
    mod <- did::att_gt(
      yname = outcome, 
      tname = "year", 
      gname = "gname", 
      data = data,
      panel = FALSE, 
      # weightsname = "expr", 
      base_period = "universal", 
      est_method = est_method
    )
  } else {
    mod <- did::att_gt(
      yname = outcome, 
      tname = "year", 
      xformla = stats::as.formula(xfm),
      gname = "gname", 
      data = data,
      panel = FALSE, 
      # weightsname = "expr", 
      base_period = "universal", 
      est_method = est_method
    )
  }
  
  return(mod)
}

#' @export
plot_mean <- function(data, outcome) {
  data <- data |> 
    dplyr::summarize(
      mean = mean(!!rlang::sym(outcome), na.rm = TRUE),
      .by = c(eligible, period)
    ) |> 
    dplyr::mutate(eligible = as.factor(eligible), period= as.numeric(as.character(period)))
  
  g <- ggplot2::ggplot(data, ggplot2::aes(x = period, y = mean, group = eligible, colour = eligible)) +
    ggplot2::geom_vline(xintercept = -3, linetype = "dashed", colour = 1) +
    ggplot2::geom_point() +
    ggplot2::geom_line() + 
    ggplot2::labs(x = "Period", y = "Mean Outcome", title = paste0(outcome, " (Mean)")) + 
    ggplot2::theme_bw()
  
  return(g)
}


#' @export
run_all_regressions <- function(outcome, data) {
  
  # Define the formulas
  simple_formula <- stats::as.formula(paste0(outcome, " ~ eligible*post"))
  multiple_formula <- stats::as.formula(paste0(outcome, " ~ eligible*post + experience + I(experience^2) + schooling + I(schooling^2) + civilstatus + region*urb"))
  
  # Run the regressions
  simple_reg <- stats::lm(simple_formula, data, 
                          # weights = data$expr
                          )
  multiple_reg <- stats::lm(multiple_formula, data, 
                            # weights = data$expr
                            )
  
  print("DONE - OLS")
  
  # Double robust DID estimation
  sz <- DRDID::drdid(
    yname = outcome,
    tname = "post",
    idname = "id",
    dname = "eligible",
    xformla = ~ schooling + civilstatus + urb,
    data = data,
    panel = FALSE,
    estMethod = "imp",
    # weightsname = "expr"
  )
  
  print("DONE - Doubly robust DID")
  
  # Inverse probability weighted DID estimation
  ipw <- DRDID::ipwdid(
    yname = outcome,
    tname = "post",
    idname = "id",
    dname = "eligible",
    xformla = ~ experience + I(experience^2) + schooling + I(schooling^2) + civilstatus + region*urb,
    data = data,
    panel = FALSE,
    boot = TRUE,
    nboot = 199,
    # weightsname = "expr"
  )
  
  print("DONE - IPW DID")
  
  # Tidy the results for OLS models and filter for the relevant term
  simple_reg_tidy <- broom::tidy(simple_reg) |> 
    dplyr::filter(term == "eligible:post") |> 
    dplyr::mutate(term = "Pooled OLS")
  multiple_reg_tidy <- broom::tidy(multiple_reg) |> 
    dplyr::filter(term == "eligible:post") |> 
    dplyr::mutate(term = "Pooled OLS with Controls")
  
  # Manually create tidy results for DRDID
  sz_tidy <- data.frame(
    term = c("DR DID"),
    estimate = sz$ATT,
    std.error = sz$se,
    statistic = sz$ATT / sz$se,
    p.value = ifelse(stats::pt(abs(sz$ATT / sz$se), nrow(data)) * 2  > 1, 
                     2 - stats::pt(abs(sz$ATT / sz$se), nrow(data)) * 2, 
                     stats::pt(abs(sz$ATT / sz$se), nrow(data)) * 2)
  )
  
  # Manually create tidy results for IPW DID
  ipw_tidy <- data.frame(
    term = c("IPW DID"),
    estimate = ipw$ATT,
    std.error = ipw$se,
    statistic = ipw$ATT / ipw$se,
    p.value = ifelse(stats::pt(abs(ipw$ATT / ipw$se), nrow(data)) * 2  > 1, 
                     2 - stats::pt(abs(ipw$ATT / ipw$se), nrow(data)) * 2, 
                     stats::pt(abs(ipw$ATT / ipw$se), nrow(data)) * 2)
  )
  
  # Combine the results
  combined_results <- dplyr::bind_rows(simple_reg_tidy, multiple_reg_tidy, sz_tidy, ipw_tidy)
  
  return(combined_results)
}

# #' @export
# sensitivity_check <- function(m1, relativeMagnitudes = TRUE) {
#   betahat <- m1[["coefficients"]][-1:-8] # save the coefficients
#   sigma <- summary(m1)[["cov.unscaled"]][-1:-8, -1:-8] # save the covariance matrix
#   
#   originalResults <- constructOriginalCS(
#     betahat = betahat,
#     sigma = sigma,
#     numPrePeriods = 3,
#     numPostPeriods = 3
#   )
#   
#   if (relativeMagnitudes == TRUE) {
#     delta_rm_results <-
#       createSensitivityResults_relativeMagnitudes(
#         betahat = betahat, # coefficients
#         sigma = sigma, # covariance matrix
#         numPrePeriods = 3, # number of pre-treatment coefficients
#         numPostPeriods = 3, # number of post-treatment coefficients
#         Mbarvec = seq(0.5, 2, by = 0.5) # values of Mbar
#       )
#     
#     g <- createSensitivityPlot_relativeMagnitudes(delta_rm_results, originalResults)
#     
#   } else {
#     delta_sd_results <- createSensitivityResults(
#       betahat = betahat,
#       sigma = sigma,
#       numPrePeriods = 3,
#       numPostPeriods = 3,
#       Mvec = seq(from = 0, to = 0.05, by = 0.01)
#     )
#     
#     g <- createSensitivityPlot(delta_sd_results, originalResults)
#   }
#   
#   return(g)
# }

functions <- list(
  run_ols = run_ols,
  prep_event_study_plot = prep_event_study_plot,
  plot_event_study = plot_event_study,
  run_cs = run_cs,
  plot_mean = plot_mean,
  run_all_regressions = run_all_regressions
)


```


# Additional sample restriction

```{r}
df_intensive <- df_intensive |> 
  filter(decil <= 8)

df_extensive <- df_extensive |> 
  filter(decil <= 8)
```

# Intensive Margin

## Job income (log)

```{r}
functions$plot_mean(df_intensive, "log_jobincome")
```


```{r}
functions$plot_event_study(
  functions$run_ols(df_intensive, "log_jobincome", F, F), 
  functions$run_ols(df_intensive, "log_jobincome", T, F)
)
```



## Total Income

```{r}
functions$plot_mean(df_intensive, "log_totalincome")
```


```{r}
functions$plot_event_study(
  functions$run_ols(df_intensive, "log_totalincome", F, F), 
  functions$run_ols(df_intensive, "log_totalincome", T, F)
)
```




## Working hours

```{r}
functions$plot_mean(df_intensive |>
                      filter(hours > 0 & hours <= 80), "log_hours")
```

```{r}
functions$plot_event_study(
  functions$run_ols(df_intensive |> filter(hours > 0 & hours <= 80), "log_hours", F, F),
  functions$run_ols(df_intensive |> filter(hours > 0 & hours <= 80), "log_hours", T, F)
)
```



# Extensive Margin

## Labor force participation

```{r}
functions$plot_mean(df_extensive, "lfp")
```

```{r}
functions$plot_event_study(
  functions$run_ols(df_extensive, "lfp", F, F),
  functions$run_ols(df_extensive, "lfp", T, F)
)
```



## Employment

```{r}
functions$plot_mean(df_extensive, "employment")
```

```{r}
functions$plot_event_study(
  functions$run_ols(df_extensive, "employment", F, F),
  functions$run_ols(df_extensive, "employment", T, F)
)
```



## Unemployment

```{r}
functions$plot_mean(df_extensive, "unemployment")
```

```{r}
functions$plot_event_study(
  functions$run_ols(df_extensive, "unemployment", F, F),
  functions$run_ols(df_extensive, "unemployment", T, F)
)
```



## Contract

```{r}
functions$plot_mean(df_extensive, "contract")
```


```{r}
functions$plot_event_study(
  functions$run_ols(df_extensive, "contract", F, F), 
  functions$run_ols(df_extensive, "contract", T, F)
)
```


```

